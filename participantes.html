<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Participantes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Montserrat", sans-serif;
        background-color: #fff;
      }

      .top-bar {
        background: linear-gradient(to right, #1b1464, #d4145a);
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .avatar {
        width: 55px;
      height: 55px;
      background-color: rgb(8, 8, 8);
      color: black;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .search-bar {
        background-color: #f1f1f1;
        padding: 10px 20px;
        margin: 20px auto;
        border-radius: 50px;
        display: flex;
        align-items: center;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .search-bar input {
        border: none;
        background: transparent;
        outline: none;
        flex-grow: 1;
        font-size: 16px;
        padding: 5px 10px;
      }

      .search-bar svg {
        width: 20px;
        height: 20px;
        fill: #666;
      }

      .categoria-header {
        text-align: center;
        color: #ff6600;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .participant-header {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        font-weight: bold;
        text-align: center;
        padding: 10px 20px;
      }

      .participant-row {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        align-items: center;
        background: #fff;
        margin: 10px 20px;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        font-weight: 500;
        text-align: center;
      }

      .btn-votar {
        border: none;
        border-radius: 30px;
        color: white;
        padding: 5px 15px;
        font-weight: bold;
        cursor: pointer;
      }

      .btn-verde {
        background-color: #73c700;
      }

      .btn-vermelho {
        background-color: #c70000;
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div></div>
      <div class="avatar"><img src="img/logo-concurso.png" width="60px" height="60px"></div>
    </div>

    <div class="search-bar">
      <input type="text" placeholder="Buscar por código ou nome..." />
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        class="ms-2"
      >
        <path
          d="M10 2a8 8 0 015.29 13.71l4.15 4.15a1 1 0 01-1.42 1.42l-4.15-4.15A8 8 0 1110 2zm0 2a6 6 0 100 12 6 6 0 000-12z"
        />
      </svg>
    </div>

    <div class="container">
      <div class="categoria-header">
        <h5 id="categoria-nome" class="mb-0"></h5>
        <h6 id="categoria-idade" class="mb-3"></h6>
      </div>

      <div class="participant-header">
        <span>CÓDIGO</span>
        <span>NOME</span>
        <span>STATUS</span>
      </div>

      <div id="participantes-lista"></div>
    </div>

    <script>
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get("id"); // id da categoria
  const cpfJurado = urlParams.get("cpfJurado");

  let participantesOriginais = [];

  document
    .querySelector(".search-bar input")
    .addEventListener("input", (e) => {
      const termo = e.target.value.toLowerCase().trim();
      const filtrados = participantesOriginais.filter(
        (p) =>
          p.codigo.toLowerCase().includes(termo) ||
          p.nome.toLowerCase().includes(termo)
      );
      renderizarParticipantes(filtrados);
    });

  function renderizarParticipantes(listaFiltrada) {
    const lista = document.getElementById("participantes-lista");
    lista.innerHTML = "";

    listaFiltrada.forEach((p) => {
      const row = document.createElement("div");
      row.className = "participant-row";
      row.dataset.id = p.id; // guarda id para facilitar atualização

      const codigo = document.createElement("span");
      codigo.textContent = p.codigo;

      const nome = document.createElement("span");
      nome.textContent = p.nome;

      const botao = document.createElement("button");
      botao.className = `btn-votar ${p.votado ? "btn-vermelho" : "btn-verde"}`;
      botao.textContent = p.votado ? "JÁ VOTADO" : "VOTAR";

      if (!p.votado) {
        botao.onclick = () => {
          window.location.href = `detalhes.html?id=${p.id}&categoria=${p.categoria.nome}&cpfJurado=${cpfJurado}`;
        };
      } else {
        botao.disabled = true;
      }

      row.appendChild(codigo);
      row.appendChild(nome);
      row.appendChild(botao);

      lista.appendChild(row);
    });
  }

  async function carregarParticipantes() {
    try {
      const resposta = await fetch(
        `https://www.rainhadafapi2025.shop/api/participantes/categoria/${id}`
      );

      if (!resposta.ok) {
        throw new Error(`Erro na requisição: ${resposta.status}`);
      }

      const participantes = await resposta.json();

      document.getElementById("categoria-nome").textContent =
        `CATEGORIA ${participantes[0].categoria.nome.toUpperCase()}`;
      document.getElementById("categoria-idade").textContent =
        `${participantes[0].categoria.idadeInicial} À ${participantes[0].categoria.idadeFinal} ANOS`;

      // Buscar IDs dos participantes já votados pelo jurado nessa categoria
      const votosRes = await fetch(
        `https://www.rainhadafapi2025.shop/api/pontuacoes/jurado/${cpfJurado}/categoria/${id}/participantes-votados`
      );
      const idsVotados = await votosRes.json();

      for (const p of participantes) {
        p.votado = idsVotados.includes(p.id);
      }

      participantesOriginais = participantes;
      renderizarParticipantes(participantesOriginais);

      iniciarPolling();

    } catch (error) {
      console.error("Erro ao carregar participantes:", error);
      document.getElementById("participantes-lista").innerHTML =
        '<p class="text-danger text-center">Erro ao carregar participantes.</p>';
    }
  }

  async function verificarVotoParticipante(participanteId) {
    try {
      const url = `https://www.rainhadafapi2025.shop/api/pontuacoes/${participanteId}/jurado/${cpfJurado}/ja-votou`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Erro na verificação de voto');
      return await res.json();
    } catch (e) {
      console.error(`Erro verificando voto para participante ${participanteId}`, e);
      return false;
    }
  }

  function atualizarBotaoVoto(participanteId, votado) {
    const lista = document.getElementById("participantes-lista");
    const rows = lista.getElementsByClassName("participant-row");
    for (const row of rows) {
      if (row.dataset.id == participanteId) {
        const botao = row.querySelector("button.btn-votar");
        if (votado) {
          botao.textContent = "JÁ VOTADO";
          botao.className = "btn-votar btn-vermelho";
          botao.disabled = true;
        } else {
          botao.textContent = "VOTAR";
          botao.className = "btn-votar btn-verde";
          botao.disabled = false;
        }
        break;
      }
    }
  }

  function iniciarPolling() {
    const intervalo = 10; // 1 segundos

    setInterval(async () => {
      for (const participante of participantesOriginais) {
        if (!participante.votado) {
          const votou = await verificarVotoParticipante(participante.id);
          if (votou) {
            participante.votado = true;
            atualizarBotaoVoto(participante.id, true);
          }
        }
      }
    }, intervalo);
  }

  carregarParticipantes();
</script>


  </body>
</html>
